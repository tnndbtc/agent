{% extends 'base.html' %}
{% load i18n %}

{% block title %}{{ project.title }} - {% trans "Novel Writing Agent" %}{% endblock %}
{% block nav_title %}{{ project.title }}{% endblock %}

{% block content %}
<div class="project-detail">
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" data-tab="overview">{% trans "Overview" %}</button>
        <button class="tab" data-tab="plot">{% trans "Plot" %}</button>
        <button class="tab" data-tab="characters">{% trans "Characters" %}</button>
        <button class="tab" data-tab="chapters">{% trans "Chapters" %}</button>
        <button class="tab" data-tab="tools">{% trans "Tools" %}</button>
    </div>

    <!-- Overview Tab -->
    <div class="tab-content active" id="overview">
        <div class="section">
            <h3>{% trans "Project Info" %}</h3>
            <div class="info-grid">
                <div class="info-item">
                    <label>{% trans "Status" %}</label>
                    <span class="status-badge status-{{ project.status }}">{{ project.get_status_display }}</span>
                </div>
                <div class="info-item">
                    <label>{% trans "Genre" %}</label>
                    <span>{{ project.genre|default:"Not set" }}</span>
                </div>
                <div class="info-item">
                    <label>{% trans "Total Words" %}</label>
                    <span>{{ project.total_word_count|default:0 }}</span>
                </div>
                <div class="info-item">
                    <label>{% trans "Chapters" %}</label>
                    <span>{{ chapters|length }}</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>{% trans "Quick Actions" %}</h3>
            <div class="action-grid">
                <button class="action-card" onclick="startBrainstorm()">
                    <span class="action-icon">üí°</span>
                    <span>{% trans "Brainstorm Ideas" %}</span>
                </button>
                <button class="action-card" onclick="showTab('plot')">
                    <span class="action-icon">üìñ</span>
                    <span>{% trans "Develop Plot" %}</span>
                </button>
                <button class="action-card" onclick="showTab('characters')">
                    <span class="action-icon">üë•</span>
                    <span>{% trans "Create Characters" %}</span>
                </button>
                <button class="action-card" onclick="createOutline()">
                    <span class="action-icon">üìã</span>
                    <span>{% trans "Generate Outline" %}</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Plot Tab -->
    <div class="tab-content" id="plot">
        <div class="section">
            <div class="section-header">
                <h3>{% trans "Plot Structure" %}</h3>
                {% if not has_plot %}
                <button class="btn btn-primary" onclick="generatePlot()">{% trans "Generate Plot" %}</button>
                {% endif %}
            </div>
            {% if has_plot %}
            <div class="plot-display">
                <div class="plot-field">
                    <label>Premise</label>
                    <p>{{ project.plot.premise }}</p>
                </div>
                <div class="plot-field">
                    <label>Genre</label>
                    <p>{{ project.plot.genre }}</p>
                </div>
                <div class="plot-field">
                    <label>Themes</label>
                    <p>{{ project.plot.themes }}</p>
                </div>
                <div class="plot-field">
                    <label>Conflict</label>
                    <p>{{ project.plot.conflict }}</p>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <p>{% trans "No plot created yet. Start by brainstorming ideas!" %}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Characters Tab -->
    <div class="tab-content" id="characters">
        <div class="section">
            <div class="section-header">
                <h3>{% trans "Characters" %}</h3>
                <button class="btn btn-primary" onclick="createCharacter()">{% trans "Add Character" %}</button>
            </div>
            {% if characters %}
            <div class="characters-list">
                {% for character in characters %}
                <div class="character-card">
                    <div class="character-header">
                        <h4>{{ character.name }}</h4>
                        <span class="role-badge">{{ character.get_role_display }}</span>
                    </div>
                    <p class="character-bio">{{ character.background|truncatewords:30 }}</p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>{% trans "No characters yet. Create your protagonist to get started!" %}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Chapters Tab -->
    <div class="tab-content" id="chapters">
        <div class="section">
            <div class="section-header">
                <h3>{% trans "Chapters" %}</h3>
                <div class="button-group">
                    {% if outlines %}
                    <button class="btn btn-secondary" onclick="createOutline()">{% trans "Add Outline" %}</button>
                    <button class="btn btn-primary" onclick="writeNextChapter()">{% trans "Write Chapter" %}</button>
                    {% else %}
                    <button class="btn btn-primary" onclick="createOutline()">{% trans "Create Outline" %}</button>
                    {% endif %}
                </div>
            </div>
            {% if outlines %}
            <div class="outlines-section">
                <h4>{% trans "Chapter Outlines" %}</h4>
                <div class="outlines-list">
                    {% for outline in outlines %}
                    <div class="outline-card">
                        <div class="outline-header">
                            <span class="outline-number">{{ outline.number }}</span>
                            <h5>{{ outline.title }}</h5>
                        </div>
                        <div class="outline-details">
                            {% if outline.pov %}
                            <p><strong>{% trans "POV:" %}</strong> {{ outline.pov }}</p>
                            {% endif %}
                            {% if outline.setting %}
                            <p><strong>{% trans "Setting:" %}</strong> {{ outline.setting }}</p>
                            {% endif %}
                            {% if outline.events %}
                            <p><strong>{% trans "Events:" %}</strong> {{ outline.events|truncatewords:30 }}</p>
                            {% endif %}
                            {% if outline.pacing %}
                            <p><strong>{% trans "Pacing:" %}</strong> {{ outline.pacing }}</p>
                            {% endif %}
                        </div>

                        {% if outline.chapter %}
                        <!-- Written Chapter -->
                        <div class="written-chapter-preview">
                            <div class="chapter-header">
                                <h5>{% trans "Written Chapter" %}</h5>
                                {% if outline.chapter.is_draft %}
                                <span class="badge badge-warning">{% trans "Draft" %}</span>
                                {% else %}
                                <span class="badge badge-success">{% trans "Complete" %}</span>
                                {% endif %}
                            </div>
                            <p class="chapter-stats">
                                {{ outline.chapter.word_count }} {% trans "words" %} ‚Ä¢
                                {% trans "Updated" %} {{ outline.chapter.updated_at|timesince }} {% trans "ago" %}
                            </p>
                            <div class="chapter-preview-actions">
                                <button class="btn btn-sm btn-primary" onclick="window.location.href='{% url 'novels:chapter_detail' project.id outline.chapter.id %}'">
                                    {% trans "View/Edit Chapter" %}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteChapter('{{ outline.chapter.id }}')">
                                    {% trans "Delete Chapter" %}
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <!-- Outline Actions (only show if no chapter written) -->
                        <div class="outline-actions">
                            <button class="btn btn-sm btn-primary" onclick="writeChapterFromOutline('{{ outline.id }}')">
                                {% trans "Write This Chapter" %}
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="regenerateOutline({{ outline.number }})">
                                {% trans "Regenerate" %}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteOutline('{{ outline.id }}')">
                                {% trans "Delete" %}
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if chapters and not outlines %}
            <!-- Show standalone chapters only if there are no outlines -->
            <div class="chapters-section">
                <h4>{% trans "Written Chapters" %}</h4>
                <div class="chapters-list">
                    {% for chapter in chapters %}
                    <div class="chapter-card">
                        <div class="chapter-number">{{ chapter.chapter_number }}</div>
                        <div class="chapter-info" onclick="window.location.href='{% url 'novels:chapter_detail' project.id chapter.id %}'" style="cursor: pointer; flex: 1;">
                            <h4>{{ chapter.title }}</h4>
                            <p>{{ chapter.word_count }} {% trans "words" %} ‚Ä¢ {{ chapter.updated_at|timesince }} {% trans "ago" %}</p>
                        </div>
                        <div class="chapter-status">
                            {% if chapter.is_draft %}
                            <span class="badge badge-warning">{% trans "Draft" %}</span>
                            {% else %}
                            <span class="badge badge-success">{% trans "Complete" %}</span>
                            {% endif %}
                        </div>
                        <div class="chapter-actions">
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteChapter('{{ chapter.id }}')">
                                {% trans "Delete" %}
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if not outlines and not chapters %}
            <div class="empty-state">
                <p>{% trans "No chapters written yet. Create an outline to start writing!" %}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tools Tab -->
    <div class="tab-content" id="tools">
        <div class="section">
            <h3>{% trans "Writing Tools" %}</h3>
            <div class="tools-grid">
                <button class="tool-card" onclick="checkConsistency()">
                    <span class="tool-icon">üîç</span>
                    <h4>{% trans "Check Consistency" %}</h4>
                    <p>{% trans "Verify character traits, settings, and timeline" %}</p>
                </button>
                <button class="tool-card" onclick="scoreNovel()">
                    <span class="tool-icon">‚≠ê</span>
                    <h4>{% trans "Score Novel" %}</h4>
                    <p>{% trans "Get AI feedback on your writing" %}</p>
                </button>
                <div class="tool-card">
                    <span class="tool-icon">üì•</span>
                    <h4>{% trans "Export" %}</h4>
                    <p>{% trans "Download or view your novel" %}</p>
                    <div class="export-actions">
                        <button class="btn btn-sm btn-primary" onclick="downloadNovel()">
                            {% trans "Download" %}
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="viewNovelOnline()">
                            {% trans "View Online" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/project.js"></script>
<script>
const projectId = '{{ project.id }}';

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        showTab(tabName);
    });
});

// Restore tab from URL hash on page load
window.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash.substring(1); // Remove the '#'
    if (hash && document.getElementById(hash)) {
        showTab(hash);
    }
});

function showTab(tabName) {
    // Close any open modals when switching tabs
    if (typeof closeNovelTextModal === 'function') {
        closeNovelTextModal();
    }

    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(tabName).classList.add('active');

    // Update URL hash to preserve tab state across page reloads
    window.location.hash = tabName;
}

function startBrainstorm() {
    window.location.href = `/project/${projectId}/brainstorm/`;
}

function createOutline() {
    const numChapters = prompt('How many chapters do you want to create?', '1');

    if (!numChapters) return;

    const chapters = parseInt(numChapters);
    if (isNaN(chapters) || chapters < 1 || chapters > 100) {
        showToast('Please enter a valid number between 1 and 100', 'error');
        return;
    }

    if (!confirm(`Create outline with ${chapters} chapters? This may take a few moments.`)) return;

    showLoading('Creating outline...');
    apiRequest(`/api/projects/${projectId}/create_outline/`, {
        method: 'POST',
        body: JSON.stringify({ num_chapters: chapters })
    }).then(data => {
        showToast('Outline generation started!', 'success');
        // Open WebSocket to track progress
        connectToTask(data.task_id);
    }).catch(err => {
        hideLoading();
        showToast('Error creating outline', 'error');
    });
}

function scoreNovel() {
    if (!confirm('Score your novel? This will analyze all chapters.')) return;

    showLoading('Scoring novel...');
    apiRequest(`/api/projects/${projectId}/score/`, {
        method: 'POST'
    }).then(data => {
        showToast('Scoring started!', 'success');
        connectToTask(data.task_id);
    }).catch(err => {
        hideLoading();
        showToast('Error scoring novel', 'error');
    });
}

function writeChapterFromOutline(outlineId) {
    // Prompt for word count
    const wordCount = prompt('How many words should this chapter be? (10-10000)', '10');

    if (wordCount === null) return; // User cancelled

    const words = parseInt(wordCount);
    if (isNaN(words) || words < 10 || words > 10000) {
        showToast('Please enter a valid word count between 10 and 10000', 'error');
        return;
    }

    if (!confirm(`Write this chapter with approximately ${words} words?`)) return;

    showLoading('Writing chapter...');
    apiRequest(`/api/projects/${projectId}/write_chapter/`, {
        method: 'POST',
        body: JSON.stringify({
            chapter_outline_id: outlineId,
            writing_style: 'literary',
            language: 'English',
            target_word_count: words
        })
    }).then(data => {
        showToast('Chapter writing started!', 'success');
        connectToTask(data.task_id);
    }).catch(err => {
        hideLoading();
        showToast('Error writing chapter: ' + err.message, 'error');
    });
}

function regenerateOutline(chapterNumber) {
    if (!confirm(`Regenerate outline for chapter ${chapterNumber}? This will replace the current outline with a new version.`)) return;

    showLoading('Regenerating outline...');
    apiRequest(`/api/projects/${projectId}/regenerate_chapter_outline/`, {
        method: 'POST',
        body: JSON.stringify({ chapter_number: chapterNumber })
    }).then(data => {
        showToast('Outline regeneration started!', 'success');
        connectToTask(data.task_id);
    }).catch(err => {
        hideLoading();
        showToast('Error regenerating outline: ' + err.message, 'error');
    });
}

function deleteOutline(outlineId) {
    if (!confirm('Delete this chapter outline? This cannot be undone.')) return;

    showLoading('Deleting outline...');
    apiRequest(`/api/projects/${projectId}/delete_outline/${outlineId}/`, {
        method: 'DELETE'
    }).then(() => {
        hideLoading();
        showToast('Outline deleted successfully!', 'success');
        setTimeout(() => window.location.reload(), 1000);
    }).catch(err => {
        hideLoading();
        showToast('Error deleting outline: ' + err.message, 'error');
    });
}

function deleteChapter(chapterId) {
    if (!confirm('Delete this chapter? This cannot be undone and all content will be lost.')) return;

    showLoading('Deleting chapter...');
    apiRequest(`/api/chapters/${chapterId}/`, {
        method: 'DELETE'
    }).then(() => {
        hideLoading();
        showToast('Chapter deleted successfully!', 'success');
        setTimeout(() => window.location.reload(), 1000);
    }).catch(err => {
        hideLoading();
        showToast('Error deleting chapter: ' + err.message, 'error');
    });
}

function downloadNovel() {
    window.location.href = `/api/projects/${projectId}/export/`;
}

function viewNovelOnline() {
    showLoading('Loading novel text...');
    apiRequest(`/api/projects/${projectId}/view_text/`, {
        method: 'GET'
    }).then(data => {
        hideLoading();
        if (!data || !data.full_text) {
            showToast('No content available to display', 'warning');
            return;
        }
        showNovelTextModal(data);
    }).catch(err => {
        hideLoading();
        showToast('Error loading novel text: ' + err.message, 'error');
    });
}

function showNovelTextModal(data) {
    // Remove any existing modal first
    closeNovelTextModal();

    // Create modal overlay with inline styles for guaranteed positioning
    const overlay = document.createElement('div');
    overlay.className = 'novel-text-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
    `;

    // Escape HTML to prevent XSS and rendering issues
    const escapeHtml = (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };

    // Create modal structure
    const modal = document.createElement('div');
    modal.className = 'novel-text-modal';
    modal.style.cssText = `
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    `;

    // Create header
    const header = document.createElement('div');
    header.className = 'novel-text-header';
    header.style.cssText = `
        padding: 20px;
        border-bottom: 2px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
    `;
    header.innerHTML = `
        <div>
            <h2 style="margin: 0; color: #111827; font-size: 24px;">${escapeHtml(data.title)}</h2>
            <p style="margin: 8px 0 0 0; color: #6B7280; font-size: 14px;">by ${escapeHtml(data.author)} | ${escapeHtml(data.genre)} | ${data.chapter_count} chapters | ${data.total_word_count} words</p>
        </div>
        <button class="btn btn-sm btn-danger" onclick="closeNovelTextModal()">‚úï Close</button>
    `;

    // Create content area
    const contentDiv = document.createElement('div');
    contentDiv.className = 'novel-text-content';
    contentDiv.style.cssText = `
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    `;

    const preElement = document.createElement('pre');
    preElement.style.cssText = `
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: 'Georgia', 'Times New Roman', serif;
        font-size: 16px;
        line-height: 1.8;
        color: #111827;
    `;
    preElement.textContent = data.full_text || '';
    contentDiv.appendChild(preElement);

    // Assemble modal
    modal.appendChild(header);
    modal.appendChild(contentDiv);
    overlay.appendChild(modal);

    // Click outside to close
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            closeNovelTextModal();
        }
    });

    // Prevent clicks inside modal from closing it
    modal.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';
}

function closeNovelTextModal() {
    // Remove all overlay instances (in case there are multiple)
    const overlays = document.querySelectorAll('.novel-text-overlay');
    overlays.forEach(overlay => overlay.remove());

    // Restore body scroll
    document.body.style.overflow = '';
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' || e.keyCode === 27) {
        closeNovelTextModal();
    }
});

// Clean up any orphaned modals on page load
window.addEventListener('DOMContentLoaded', function() {
    closeNovelTextModal();
});

// Clean up modals before page unload
window.addEventListener('beforeunload', function() {
    closeNovelTextModal();
});
</script>
{% endblock %}
