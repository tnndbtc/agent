{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Dashboard" %} - {% trans "Novel Writing Agent" %}{% endblock %}
{% block nav_title %}{% trans "My Projects" %}{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2>{% trans "My Novel Projects" %}</h2>
        <button class="btn btn-primary" onclick="createNewProject()">
            â• {% trans "New Project" %}
        </button>
    </div>

    {% if projects %}
    <div class="projects-grid">
        {% for project in projects %}
        <div class="project-card" onclick="window.location.href='{% url 'novels:project_detail' project.id %}'">
            <div class="project-header">
                <h3>{{ project.title }}</h3>
                <div class="project-header-actions">
                    <span class="status-badge status-{{ project.status }}">{{ project.get_status_display }}</span>
                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteProject('{{ project.id }}', '{{ project.title }}')">
                        ğŸ—‘ï¸ {% trans "Delete" %}
                    </button>
                </div>
            </div>
            <div class="project-meta">
                <p class="genre">{{ project.genre_display|default:"No genre" }}</p>
                <div class="project-stats">
                    <span>ğŸ“ {{ project.chapters.count }} {% trans "chapters" %}</span>
                    <span>ğŸ“Š {{ project.total_word_count|default:0 }} {% trans "words" %}</span>
                </div>
                <p class="updated">{% trans "Updated" %} {{ project.updated_at|timesince }} {% trans "ago" %}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ“š</div>
        <h3>{% trans "No projects yet" %}</h3>
        <p>{% trans "Start your first novel project by clicking the button above" %}</p>
    </div>
    {% endif %}
</div>

<!-- Create Project Modal -->
<div class="modal" id="createProjectModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>{% trans "Create New Project" %}</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="createProjectForm" class="modal-form">
            <div class="form-group">
                <label for="title">{% trans "Project Title" %}</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="genreSelect">{% trans "Genre" %}</label>
                <select id="genreSelect" name="genreSelect" onchange="handleGenreChange()">
                    <option value="">{% trans "Select a genre..." %}</option>
                    <option value="Fantasy">{% trans "Fantasy" %}</option>
                    <option value="Science Fiction">{% trans "Science Fiction" %}</option>
                    <option value="Romance">{% trans "Romance" %}</option>
                    <option value="Mystery">{% trans "Mystery" %}</option>
                    <option value="Thriller">{% trans "Thriller" %}</option>
                    <option value="Horror">{% trans "Horror" %}</option>
                    <option value="Historical Fiction">{% trans "Historical Fiction" %}</option>
                    <option value="Literary Fiction">{% trans "Literary Fiction" %}</option>
                    <option value="Young Adult">{% trans "Young Adult" %}</option>
                    <option value="Adventure">{% trans "Adventure" %}</option>
                    <option value="Dystopian">{% trans "Dystopian" %}</option>
                    <option value="Custom">{% trans "Custom (Enter your own)" %}</option>
                </select>
            </div>
            <div class="form-group" id="customGenreGroup" style="display: none;">
                <label for="customGenre">{% trans "Custom Genre" %}</label>
                <input type="text" id="customGenre" name="customGenre" placeholder="{% trans "Enter custom genre..." %}">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">{% trans "Cancel" %}</button>
                <button type="submit" class="btn btn-primary">{% trans "Create" %}</button>
            </div>
        </form>
    </div>
</div>

<script>
function createNewProject() {
    document.getElementById('createProjectModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('createProjectModal').style.display = 'none';
    // Reset form
    document.getElementById('createProjectForm').reset();
    document.getElementById('customGenreGroup').style.display = 'none';
}

function handleGenreChange() {
    const genreSelect = document.getElementById('genreSelect');
    const customGenreGroup = document.getElementById('customGenreGroup');

    if (genreSelect.value === 'Custom') {
        customGenreGroup.style.display = 'block';
    } else {
        customGenreGroup.style.display = 'none';
    }
}

document.getElementById('createProjectForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const genreSelect = formData.get('genreSelect');

    // Determine the final genre value
    let genre = '';
    if (genreSelect === 'Custom') {
        genre = formData.get('customGenre') || '';
    } else {
        genre = genreSelect || '';
    }

    const data = {
        title: formData.get('title'),
        genre: genre,
    };

    try {
        showLoading('Creating project...');
        const response = await apiRequest('/api/projects/', {
            method: 'POST',
            body: JSON.stringify(data)
        });
        hideLoading();
        showToast('Project created successfully!', 'success');
        setTimeout(() => window.location.reload(), 1000);
    } catch (error) {
        hideLoading();
        showToast('Error creating project', 'error');
    }
});

function deleteProject(projectId, projectTitle) {
    if (!confirm(`Are you sure you want to delete "${projectTitle}"? This action cannot be undone and will delete all chapters, outlines, and related data.`)) {
        return;
    }

    showLoading('Deleting project...');
    apiRequest(`/api/projects/${projectId}/`, {
        method: 'DELETE'
    }).then(() => {
        hideLoading();
        showToast('Project deleted successfully!', 'success');
        setTimeout(() => window.location.reload(), 1000);
    }).catch(err => {
        hideLoading();
        showToast('Error deleting project: ' + err.message, 'error');
    });
}
</script>
{% endblock %}
