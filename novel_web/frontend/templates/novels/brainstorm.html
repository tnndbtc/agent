{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Brainstorm Ideas" %} - {{ project.title }}{% endblock %}
{% block nav_title %}{% trans "Brainstorm Ideas" %}{% endblock %}

{% block content %}
<div class="brainstorm-page">
    <div class="section">
        <div class="section-header">
            <h2>{% trans "Brainstorm Plot Ideas" %}</h2>
            <button class="btn btn-secondary" onclick="window.location.href='{% url 'novels:project_detail' project.id %}'">
                ‚Üê {% trans "Back to Project" %}
            </button>
        </div>

        <!-- Previously Saved Ideas - Moved to Top -->
        {% if previous_ideas %}
        <div class="saved-ideas-section" style="margin-top: 1rem;">
            <h3>My Idea</h3>
            <div class="ideas-container">
                {% for idea in previous_ideas|slice:":1" %}
                <div class="idea-card current-idea">
                    <div class="idea-premise" style="font-size: 1rem; margin-bottom: 1rem;">
                        {% firstof idea.premise idea.description "No description" %}
                    </div>
                    {% if idea.genre %}
                    <div class="idea-tags">
                        <span class="tag">{{ idea.genre }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="modifyIdea()">
                    ‚úèÔ∏è Modify Idea
                </button>
                <button class="btn btn-primary" onclick="useCurrentIdea()">
                    ‚ú® Create Plot & Characters
                </button>
            </div>
        </div>

        <!-- Edit Form - Hidden by default -->
        <div id="editSection" style="display: none; margin-top: 1.5rem;">
            <form id="editForm" class="form-card">
                <div class="form-group">
                    <label for="edit_premise">Idea</label>
                    <textarea id="edit_premise" name="premise" class="form-control" rows="4" required
                              placeholder="Describe your plot idea...">{% firstof previous_ideas.0.premise previous_ideas.0.description "" %}</textarea>
                </div>

                <div class="form-group">
                    <label>{% trans "Genre" %}</label>
                    <div class="genre-display">{{ project.genre_display|default:"Not specified" }}</div>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        üíæ Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>

        {% else %}
        <!-- Original Brainstorm Page - Only shown when no ideas exist -->
        <div class="info-message">
            <p>{% trans "Generate creative plot ideas for your novel. You can customize the genre, theme, and number of ideas to generate." %}</p>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle">
            <button type="button" class="mode-btn active" data-mode="generate" onclick="switchMode('generate')">
                ü§ñ Generate Ideas
            </button>
            <button type="button" class="mode-btn" data-mode="manual" onclick="switchMode('manual')">
                ‚úçÔ∏è Manual Input
            </button>
        </div>

        <!-- AI Generation Form -->
        <form id="brainstormForm" class="form-card" style="display: block;">
            <div class="form-group">
                <label>{% trans "Genre" %}</label>
                <div class="genre-display">{{ project.genre_display|default:"Not specified" }}</div>
            </div>

            <div class="form-group">
                <label for="theme">{% trans "Theme" %} ({% trans "optional" %})</label>
                <input type="text" id="theme" name="theme" class="form-control"
                       placeholder="{% trans "e.g., Redemption, Coming of age, Good vs Evil" %}">
                <small class="form-text">{% trans "Enter a theme to guide the brainstorming" %}</small>
            </div>

            <div class="form-group">
                <label for="num_ideas">{% trans "Number of Ideas" %}</label>
                <input type="number" id="num_ideas" name="num_ideas" class="form-control"
                       value="3" min="1" max="20" required>
                <small class="form-text">{% trans "Enter a number between 1 and 20" %}</small>
            </div>

            <button type="submit" class="btn btn-primary btn-block">
                {% trans "Generate Ideas" %}
            </button>
        </form>

        <!-- Manual Input Form -->
        <form id="manualForm" class="form-card" style="display: none;">
            <div class="form-group">
                <label for="manual_premise">Idea</label>
                <textarea id="manual_premise" name="premise" class="form-control" rows="4" required
                          placeholder="Describe your plot idea..."></textarea>
            </div>

            <div class="form-group">
                <label>{% trans "Genre" %}</label>
                <div class="genre-display">{{ project.genre_display|default:"Not specified" }}</div>
            </div>

            <div id="progressContainer" class="progress-container">
                <div class="progress-bar">
                    <div id="progressBarFill" class="progress-bar-fill">0%</div>
                </div>
                <div id="progressText" class="progress-text">Saving idea and creating plot & characters...</div>
            </div>

            <button type="submit" class="btn btn-primary btn-block" id="saveIdeaBtn">
                üíæ Save Idea
            </button>
        </form>

        <div id="resultsSection" class="results-section" style="display: none;">
            <h3>{% trans "Generated Ideas" %}</h3>
            <div id="ideasContainer" class="ideas-container"></div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.brainstorm-page {
    padding: 1rem;
    max-width: 800px;
    margin: 0 auto;
}

.section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.section-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #1f2937;
}

.info-message {
    background: #eff6ff;
    border-left: 4px solid #3b82f6;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 4px;
}

.info-message p {
    margin: 0;
    color: #1e40af;
}

.form-card {
    background: #f9fafb;
    padding: 1.5rem;
    border-radius: 8px;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #374151;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: #4f46e5;
    color: white;
}

.btn-primary:hover {
    background: #4338ca;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background: #4b5563;
}

.btn-block {
    width: 100%;
    margin-top: 1rem;
}

.results-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #e5e7eb;
}

.results-section h3 {
    margin-bottom: 1rem;
    color: #1f2937;
}

.ideas-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.idea-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
    transition: all 0.2s;
    cursor: pointer;
}

.idea-card:hover {
    border-color: #4f46e5;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
}

.idea-card.selected {
    border-color: #4f46e5;
    background: #eff6ff;
}

.idea-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

.idea-premise {
    color: #4b5563;
    line-height: 1.6;
    margin-bottom: 0.75rem;
}

.idea-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.tag {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #e0e7ff;
    color: #4338ca;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
}

.action-buttons {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
}

.mode-toggle {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    background: #f9fafb;
    padding: 0.5rem;
    border-radius: 8px;
}

.mode-btn {
    flex: 1;
    padding: 0.75rem 1.5rem;
    border: 2px solid transparent;
    border-radius: 6px;
    background: white;
    color: #6b7280;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.mode-btn:hover {
    background: #f3f4f6;
}

.mode-btn.active {
    background: #4f46e5;
    color: white;
    border-color: #4338ca;
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

.saved-ideas-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid #e5e7eb;
}

.saved-ideas-section h3 {
    margin-bottom: 1.5rem;
    color: #1f2937;
    font-size: 1.5rem;
}

.saved-idea {
    opacity: 0.85;
}

.saved-idea:hover {
    opacity: 1;
}

.genre-display {
    padding: 0.75rem;
    background: #e0e7ff;
    border: 1px solid #c7d2fe;
    border-radius: 6px;
    color: #4338ca;
    font-weight: 500;
    font-size: 1rem;
}

.progress-container {
    margin: 1.5rem 0;
    display: none;
}

.progress-bar {
    width: 100%;
    height: 30px;
    background: #e5e7eb;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
    border-radius: 15px;
    transition: width 0.3s ease;
    width: 0%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
}

.progress-text {
    margin-top: 0.5rem;
    text-align: center;
    color: #6b7280;
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .action-buttons {
        flex-direction: column;
    }

    .action-buttons .btn {
        width: 100%;
    }
}
</style>

<script>
const projectId = '{{ project.id }}';
let currentIdea = {{ previous_ideas|length }} > 0 ? {
    title: '{{ previous_ideas.0.title|default:"My Idea"|escapejs }}',
    premise: `{{ previous_ideas.0.premise|default:""|escapejs }}`,
    genre: '{{ previous_ideas.0.genre|default:"General"|escapejs }}'
} : null;

function modifyIdea() {
    document.getElementById('editSection').style.display = 'block';
    document.querySelector('.saved-ideas-section').style.display = 'none';
}

function cancelEdit() {
    document.getElementById('editSection').style.display = 'none';
    document.querySelector('.saved-ideas-section').style.display = 'block';
}

function useCurrentIdea() {
    if (!currentIdea) {
        showToast('No idea found', 'error');
        return;
    }

    if (!confirm('Create plot and characters from this idea?')) {
        return;
    }

    showLoading('Creating plot and characters...');

    apiRequest(`/api/projects/${projectId}/create_plot/`, {
        method: 'POST',
        body: JSON.stringify({ idea_data: currentIdea })
    }).then(response => {
        hideLoading();
        showToast('Plot and characters created successfully!', 'success');
        setTimeout(() => {
            window.location.href = '{% url 'novels:project_detail' project.id %}';
        }, 1500);
    }).catch(error => {
        hideLoading();
        showToast('Error creating plot and characters: ' + error.message, 'error');
    });
}

// Progress bar management
let progressInterval = null;
let currentProgress = 0;

function startProgressBar() {
    const progressContainer = document.getElementById('progressContainer');
    const progressBarFill = document.getElementById('progressBarFill');
    const saveBtn = document.getElementById('saveIdeaBtn');

    if (progressContainer) {
        progressContainer.style.display = 'block';
        saveBtn.disabled = true;
        saveBtn.style.opacity = '0.6';
        currentProgress = 0;

        progressInterval = setInterval(() => {
            if (currentProgress < 95) {
                currentProgress += 5;
                progressBarFill.style.width = currentProgress + '%';
                progressBarFill.textContent = currentProgress + '%';
            }
        }, 2000); // Add 5% every 2 seconds
    }
}

function completeProgressBar() {
    const progressBarFill = document.getElementById('progressBarFill');

    if (progressInterval) {
        clearInterval(progressInterval);
    }

    currentProgress = 100;
    progressBarFill.style.width = '100%';
    progressBarFill.textContent = '100%';
}

function resetProgressBar() {
    const progressContainer = document.getElementById('progressContainer');
    const progressBarFill = document.getElementById('progressBarFill');
    const saveBtn = document.getElementById('saveIdeaBtn');

    if (progressInterval) {
        clearInterval(progressInterval);
    }

    if (progressContainer) {
        progressContainer.style.display = 'none';
        currentProgress = 0;
        progressBarFill.style.width = '0%';
        progressBarFill.textContent = '0%';
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';
    }
}

// Manual form submission - for new ideas
const manualForm = document.getElementById('manualForm');
if (manualForm) {
    manualForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const projectGenre = '{{ project.genre_display|default:"General"|escapejs }}';
        const manualIdea = {
            title: 'My Idea',
            premise: document.getElementById('manual_premise').value,
            genre: projectGenre
        };

        try {
            startProgressBar();

            // Save the idea to the database
            await apiRequest(`/api/projects/${projectId}/save_manual_idea/`, {
                method: 'POST',
                body: JSON.stringify({ idea: manualIdea })
            });

            // Automatically create plot and characters
            await apiRequest(`/api/projects/${projectId}/create_plot/`, {
                method: 'POST',
                body: JSON.stringify({ idea_data: manualIdea })
            });

            completeProgressBar();
            showToast('Idea saved and plot/characters created successfully!', 'success');

            // Redirect to project detail page
            setTimeout(() => {
                window.location.href = '{% url 'novels:project_detail' project.id %}';
            }, 1500);
        } catch (error) {
            resetProgressBar();
            showToast('Error: ' + error.message, 'error');
        }
    });
}

// Edit form submission - for modifying existing ideas
const editForm = document.getElementById('editForm');
if (editForm) {
    editForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const projectGenre = '{{ project.genre_display|default:"General"|escapejs }}';
        const updatedIdea = {
            title: 'My Idea',
            premise: document.getElementById('edit_premise').value,
            genre: projectGenre
        };

        try {
            showLoading('Saving changes...');

            // Save the updated idea
            await apiRequest(`/api/projects/${projectId}/save_manual_idea/`, {
                method: 'POST',
                body: JSON.stringify({ idea: updatedIdea })
            });

            hideLoading();
            showToast('Changes saved successfully! Reloading...', 'success');

            // Reload to show updated idea
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } catch (error) {
            hideLoading();
            showToast('Error saving changes: ' + error.message, 'error');
        }
    });
}

// Mode switching for AI generation vs manual input
function switchMode(mode) {
    const generateBtn = document.querySelector('[data-mode="generate"]');
    const manualBtn = document.querySelector('[data-mode="manual"]');
    const brainstormForm = document.getElementById('brainstormForm');
    const manualForm = document.getElementById('manualForm');

    if (mode === 'generate') {
        generateBtn.classList.add('active');
        manualBtn.classList.remove('active');
        brainstormForm.style.display = 'block';
        manualForm.style.display = 'none';
    } else {
        generateBtn.classList.remove('active');
        manualBtn.classList.add('active');
        brainstormForm.style.display = 'none';
        manualForm.style.display = 'block';
    }
}

// AI brainstorm form submission
const brainstormForm = document.getElementById('brainstormForm');
if (brainstormForm) {
    brainstormForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const projectGenre = '{{ project.genre_display|default:""|escapejs }}';
        if (!projectGenre) {
            showToast('Please set a genre for your project first', 'error');
            return;
        }

        const formData = {
            genre: projectGenre,
            theme: document.getElementById('theme').value || undefined,
            num_ideas: parseInt(document.getElementById('num_ideas').value)
        };

        generateIdeas(formData);
    });
}

function generateIdeas(data) {
    showLoading('Generating ideas... This may take a moment.');

    apiRequest(`/api/projects/${projectId}/brainstorm/`, {
        method: 'POST',
        body: JSON.stringify(data)
    }).then(response => {
        showToast('Ideas generation started!', 'success');
        pollTask(response.task_id);
    }).catch(error => {
        hideLoading();
        showToast('Error generating ideas: ' + error.message, 'error');
    });
}

function pollTask(taskId) {
    const interval = setInterval(() => {
        apiRequest(`/api/tasks/${taskId}/`)
            .then(task => {
                if (task.status === 'completed') {
                    clearInterval(interval);
                    hideLoading();
                    displayIdeas(task.result_data.ideas);
                } else if (task.status === 'failed') {
                    clearInterval(interval);
                    hideLoading();
                    showToast('Failed to generate ideas: ' + task.error_message, 'error');
                }
            })
            .catch(error => {
                clearInterval(interval);
                hideLoading();
                showToast('Error checking task status', 'error');
            });
    }, 2000);
}

function displayIdeas(ideas) {
    const container = document.getElementById('ideasContainer');
    const resultsSection = document.getElementById('resultsSection');

    container.innerHTML = '';

    ideas.forEach((idea, index) => {
        const card = document.createElement('div');
        card.className = 'idea-card';
        card.dataset.index = index;

        card.innerHTML = `
            <div class="idea-title">${idea.title || 'Idea ' + (index + 1)}</div>
            <div class="idea-premise">${idea.premise || idea.description || ''}</div>
            ${idea.genre ? `<div class="idea-tags"><span class="tag">${idea.genre}</span></div>` : ''}
        `;

        card.addEventListener('click', () => selectIdea(card, idea));
        container.appendChild(card);
    });

    // Add action buttons
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'action-buttons';
    actionsDiv.innerHTML = `
        <div style="flex: 1;">
            <button class="btn btn-primary" id="useSelectedBtn" disabled style="width: 100%; opacity: 0.5;">Use Selected Idea</button>
            <small id="selectReminder" style="display: block; margin-top: 0.5rem; color: #6b7280; text-align: center;">Select an idea to continue</small>
        </div>
        <button class="btn btn-secondary" onclick="window.location.href='{% url 'novels:project_detail' project.id %}'">Back to Project</button>
    `;
    container.appendChild(actionsDiv);

    document.getElementById('useSelectedBtn').addEventListener('click', useSelectedIdea);

    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}

let selectedIdea = null;

function selectIdea(card, idea) {
    document.querySelectorAll('.idea-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedIdea = idea;

    const useBtn = document.getElementById('useSelectedBtn');
    const reminder = document.getElementById('selectReminder');

    if (useBtn) {
        useBtn.disabled = false;
        useBtn.style.opacity = '1';
    }

    if (reminder) {
        reminder.style.display = 'none';
    }
}

function useSelectedIdea() {
    if (!selectedIdea) {
        showToast('Please select an idea first', 'error');
        return;
    }

    if (!confirm('Use this idea to create the plot and characters for your novel?')) {
        return;
    }

    showLoading('Creating plot and characters...');

    apiRequest(`/api/projects/${projectId}/create_plot/`, {
        method: 'POST',
        body: JSON.stringify({ idea_data: selectedIdea })
    }).then(response => {
        hideLoading();
        showToast('Plot and characters created successfully!', 'success');
        setTimeout(() => {
            window.location.href = '{% url 'novels:project_detail' project.id %}';
        }, 1500);
    }).catch(error => {
        hideLoading();
        showToast('Error creating plot and characters: ' + error.message, 'error');
    });
}
</script>
{% endblock %}
